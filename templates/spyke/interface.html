{% extends 'spyke/base.html' %}
{% load static %}

{% block content %}

{% csrf_token %}

<link rel="stylesheet" href="{% static 'spyke/interface.css' %}">

<div id='app'>

    <div id='outer-container'>

        <!-- Header -->
        <div id='header-container'>
            <h1 id='title'>Spyke</h1>

            <div id='control-container'>

                <!-- Save -->
                <div class='control-button-container' @click='savePopup()'>
                    <i id='save-control' class="control fas fa-save"></i>
                    <b class='control-button-label'>Save</b>
                </div>

                <!-- Load -->
                <div class='control-button-container' @click='loadPopup()'>
                    <i id='load-control' class="control fas fa-folder-open"></i>
                    <b class='control-button-label'>Load</b>
                </div>


                <!-- Run control -->
                <div class='control-button-container' @click='runSimulation'>
                    <i id='run-control' class="control fas fa-play-circle"></i>
                    <div v-show='status.runningSim' class="spinner-border text-primary" id='run-control-spinner' role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <b class='control-button-label'>Run</b>
                </div>

                <!-- Refresh -->
                <div class='control-button-container'>
                    <i id='refresh-control' class="control fas fa-sync-alt"></i>
                    <b class='control-button-label'>Refresh</b>
                </div>
            </div>
        </div>

        <!-- Main -->
        <div id='main-container'>

            <!-- Sidebar -->
            <div id='sidebar-container'>

                <h2 class='sidebar-header-main'>Configuration</h2>

                <!-- Sidebar Tabs -->

                <div id='sidebar-tabs-container'>
                    <div class='sidebar-tab'
                         @click='changeSettingsTab("simulation")'
                         v-bind:class="{ active: settingsTab=='simulation' }">
                        <h4 class='sidebar-tab-title'>
                            Simulation
                        </h4>
                    </div>

                    <div class='sidebar-tab'
                         @click='changeSettingsTab("stimuli")'
                         v-bind:class="{ active: settingsTab=='stimuli' }">
                        <h4 class='sidebar-tab-title'>
                            Stimuli
                        </h4>
                    </div>

                    <div class='sidebar-tab'
                         @click='changeSettingsTab("neuron")'
                         v-bind:class="{ active: settingsTab=='neuron' }">
                        <h4 class='sidebar-tab-title'>
                            Neuron
                        </h4>
                    </div>

                    <div class='sidebar-tab'
                         @click='changeSettingsTab("connections")'
                         v-bind:class="{ active: settingsTab=='connections' }">
                        <h4 class='sidebar-tab-title'>
                            Conn
                        </h4>
                    </div>
                </div>

                <!-- Sidebar Sections -->

                <!-- Simulation Section -->
                <div class='sidebar-section' v-if="settingsTab == 'simulation'">

                    <div class='sidebar-header-container'>
                        <h3 class='sidebar-header'>
                            Simulation
                        </h3>
                    </div>

                    <div class='sidebar-section-content'>

                        <div class='buffer'></div>

                        <div class="form-group row sidebar-input-group" v-for='opt in labels.simulation'>
                            <div class='col-8'>
                                <label v-bind:for="opt.attribute" class='row sidebar-input-label'>[[opt.label]]</label>
                                <small v-bind:id="opt.attribute + 'Help'" class="form-text text-muted sidebar-input-help row">[[opt.helptext]]</small>
                            </div>
                            <div class='col-4'>
                                <input type="number" class="form-control sidebar-input-number" v-bind:id="opt.attribute" v-model="simulation[opt.attribute]">
                            </div>
                        </div>


                          <div class='button-container'>
                            <!-- <button class='btn btn-success' @click='runSimulation'>Run</button> -->
                          </div>

                    </div>
                </div>

                <!-- Stimulus Section -->
                <div class='sidebar-section' v-if="settingsTab == 'stimuli'">

                    <h3 class='sidebar-header'>Stimuli</h3>

                    <div class='sidebar-section-content'>

                        <div v-for='(stim, index) in stimuli' class='config-item-container'>

                            <div class='config-item-header-container' onclick="toggleHideNext(this);">
                                <h5 class='config-item-header'>
                                [[ stim.name ]]
                                </h5>
                                
                                <div class='config-item-header-delete-container' @click="removeStimulus(index)">
                                    <i class="fas fa-times-circle close-icon" ></i>
                                </div>

                                <div class='config-item-header-options-container'>
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>
                            </div>

                            <div class='config-item-body-container collapse'>

                                <div class="form-group row sidebar-input-group">
                                    <div class='col-6'>
                                        <label class='row sidebar-input-label' for="stim-neuron">Neuron</label>
                                        <small id="stim-neuron-help" class="form-text text-muted sidebar-input-help row">Neuron to attach stim to</small>
                                    </div>
                                    <div class='col-6'>
                                        <select class="form-control" id="stim-neuron" v-model="stim.neuron">
                                            <option v-for='neuron in neurons' v-bind:value='neuron.gid'>
                                                Neuron [[neuron.gid]]
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row sidebar-input-group">
                                    <div class='col-6'>
                                        <label class='row sidebar-input-label' for="stim-sec">Section</label>
                                        <small id="stim-sec-help" class="form-text text-muted sidebar-input-help row">Section to attach stim to</small>
                                    </div>
                                    <div class='col-6'>
                                        <select class="form-control" id="stim-sec" v-model="stim.section">
                                            <option v-for='sec in getSections(stim.neuron)' v-bind:value='sec.name'>
                                                [[sec.name]]
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row sidebar-input-group">
                                    <div class='col-8'>
                                        <label for="stim-loc" class='row sidebar-input-label'>Location</label>
                                        <small id="stim-locHelp" class="form-text text-muted sidebar-input-help row">Location of stimulus on segment</small>
                                    </div>
                                    <div class='col-4'>
                                        <input type="number" class="form-control sidebar-input-number" id="stim-loc" v-model="stim.loc" min="0" max="1" step="0.1">
                                    </div>
                                </div>

                                <div class="form-group row sidebar-input-group" v-for='opt in stim.parameters'>
                                    <div class='col-8'>
                                        <label v-bind:for="opt.name" class='row sidebar-input-label'>[[opt.title]]</label>
                                        <small v-bind:id="opt.name + 'Help'" class="form-text text-muted sidebar-input-help row" v-html="opt.help"></small>
                                    </div>
                                    <div class='col-4'>
                                        <input type="number" class="form-control sidebar-input-number" v-bind:id="opt.attribute" v-model="opt.value" v-bind:step="opt.step">
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class='new-config-item-container'>

                            <div class='new-config-item-select-container'>

                                <select class='form-control new-config-item-select' v-model='selectedStimulus'>

                                    <option v-for='stimulus in availableStimuli' :value='stimulus.name'>
                                        [[stimulus.title]]
                                    </option>

                                </select>

                            </div>

                            <button class='new-config-item btn' @click='addStimulus(selectedStimulus)'>
                                +
                            </button>

                        </div>

                    </div>

                </div>

                <!-- Neuron Section -->
                <div class='sidebar-section' v-if="settingsTab == 'neuron'">

                    <h3 class='sidebar-header'>Neurons</h3>

                    <div class='sidebar-section-content'>

                        <div class='config-item-container' v-for="(neuron, index) in neurons" :key="neuron.gid">

                            <!-- Pop Menu -->
                            <div class='pop-menu-container'>
                                <div class='pop-menu'>
                                    <div class="pop-menu-item" 
                                          v-for="item in menus.nrn" 
                                          @click="item.func()(neuron.gid);"
                                          v-html="item.label">
                                    </div>
                                </div>
                            </div>

                            <div class='config-item-header-container' onclick="toggleHideNext(this);" :id="'neuron-header-'+neuron.gid">
                                <div class='config-item-header'>
                                    <input type="text" class='neuron-name' v-model="neuron.name" @click.stop
                                    :style="{width: neuronTextWidth(neuron.gid, 7.8, 30)}">
                                    </input>
                                </div>

                                <div class='neuron-color-container'>
                                    <input type="color" class='neuron-color' v-model="neuron.color" @click.stop :style="{ background: neuron.color}">
                                    </input>
                                </div>

                                <div class='config-item-header-options-container' onclick="showMenu(event);">
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>

                            </div>


                            <div :id="'neuron-body-'+neuron.gid"
                                 class='config-item-body-container collapse'>

                                <!-- Sections -->
                                <div v-for='(sec, secIndex) in neuron.sections'>

                                    <div class='sidebar-section-heading-container' onclick="toggleHideNext(this);" :style="{ background: neuron.color + 66}">
                                        <h4 class='sidebar-section-heading'>[[sec.name]]</h4>

                                        <div class='sidebar-section-subheading-icon-container' @click="removeSection(neuron.gid, secIndex, $event)">
                                            <i class="fas fa-times-circle close-icon" ></i>
                                        </div>
                                    </div>

                                    <div class='sidebar-section-body-container collapse'>

                                        <div class='sidebar-section-subheading-container'>

                                            <div class='sidebar-section-subheading-icon-container'>
                                                <!-- <i class="fas fa-chevron-down"></i> -->
                                            </div>

                                        </div>

                                        <h5 class='sidebar-section-subheading'>Parent</h5>

                                        <div class="form-group row sidebar-input-group">
                                            <div class='col-6'>
                                                <label class='row sidebar-input-label' for="section-parent">Parent Section</label>
                                                <small id="section-parent-help" class="form-text text-muted sidebar-input-help row">Parent of Section</small>
                                            </div>
                                            <div class='col-6'>
                                                <select class="form-control" id="section-parent" v-model="sec.parent">
                                                    <option :value="null">
                                                     None
                                                    </option>
                                                    <option v-for='osec in getSections(neuron.gid)' v-bind:value='osec.gid' v-if='osec.gid != sec.gid'>
                                                     [[osec.name]]
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <h5 class='sidebar-section-subheading'>Geometry</h5>

                                        <div class="form-group row sidebar-input-group" v-for='opt in labels.geometry'>
                                            <div class='col-7'>
                                                <label v-bind:for="opt.attribute" class='row sidebar-input-label'>[[opt.label]]</label>
                                                <small v-bind:id="opt.attribute + 'Help'" class="form-text text-muted sidebar-input-help row">[[opt.helptext]]</small>
                                            </div>
                                            <div class='col-5'>
                                                <input type="number" class="form-control sidebar-input-number" v-bind:step="opt.step" v-bind:id="opt.attribute" v-model.number="sec.geometry[opt.attribute]" @change="updateSec(sec, 'geometry', opt.attribute, $event)">
                                            </div>
                                        </div>

                                        <div class="form-group row sidebar-input-group">
                                            <div class='col-7'>
                                                <label for="nseg" class='row sidebar-input-label'>No. Segments</label>
                                                <small id="nseg + 'Help'" class="form-text text-muted sidebar-input-help row">Number of Segments</small>
                                            </div>
                                            <div class='col-5'>
                                                <input type="number" class="form-control sidebar-input-number" v-model="sec._geometry['nseg']" @change="sec.updateSegments()"
                                                step=1>
                                            </div>
                                        </div>

                                        <h5 class='sidebar-section-subheading'>Biophysics</h5>

                                        <div class="form-group row sidebar-input-group" v-for='opt in labels.biophysics'>
                                            <div class='col-7'>
                                                <label v-bind:for="opt.attribute" class='row sidebar-input-label'>[[opt.label]]</label>
                                                <small v-bind:id="opt.attribute + 'Help'" class="form-text text-muted sidebar-input-help row" v-html="opt.helptext"></small>
                                            </div>
                                            <div class='col-5'>
                                                <input type="number" class="form-control sidebar-input-number" v-bind:step="opt.step" v-bind:id="opt.attribute" v-model.number="sec.biophysics[opt.attribute]" @change="updateSec(sec, 'biophysics', opt.attribute, $event)">
                                            </div>
                                        </div>

                                        <!-- Channels -->
                                        <div class='sidebar-input-group-container' v-for='(channel, channelName) in sec.channels'>

                                            <div class='sidebar-input-group-boundary'>
                                            </div>

                                            <div class='sidebar-section-subheading-container'>

                                                <h5 class='sidebar-section-subheading'> [[channel.data('title')]]</h5>

                                                <div class='sidebar-section-subheading-icon-container' 
                                                     @click="removeChannel(neuron, sec.name, channelName)">
                                                    <i class="fas fa-times-circle close-icon" ></i>
                                                </div>

                                                <div class='sidebar-section-subheading-icon-container'>
                                                    <!-- <i class="fas fa-chevron-down"></i> -->
                                                </div>

                                            </div>

                                            <div class="form-group row sidebar-input-group" v-for='(val, param) in channel' v-if="param != 'data'">
                                                <div class='col-7'>
                                                    <label v-bind:for="param" class='row sidebar-input-label'>[[channel.data('title', param)]]</label>
                                                    <small v-bind:id="param + 'Help'" class="form-text text-muted sidebar-input-help row" v-html="channel.data('help', param)"></small>
                                                </div>
                                                <div class='col-5'>
                                                    <input type="number" class="form-control sidebar-input-number" v-bind:step="channel.data('step', param)" v-bind:id="param" v-model="channel[param]"
                                                    @change="updateSec(sec, 'channels.' +channelName, param, $event)">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group row sidebar-input-group">
                                            <div class='col-8'>
                                                <select class="form-control" :id="neuron.gid + '-' + sec.name + '-newChannel'">
                                                    <option v-for="channel in availableChannels(neuron.gid, sec.name)" v-bind:value='channel.name'>
                                                        [[channel.title]]
                                                    </option>
                                                </select>
                                            </div>
                                            <div class='col-4'>
                                                <button class='addChannel btn' @click="addChannel(neuron, sec.name)">+
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                    
                                </div>

                                <!-- New Section -->
                                <div class='sidebar-section-body-footer'>
                                    <a id='addSection' @click='addSection(neuron.gid)' :style="{ color: neuron.color}">Add Section</a>
                                </div>
                            </div>
                            <!-- Neuron Body container -->

                        </div>

                        <div class='new-config-item-container'>

                            <button class='new-config-item btn' @click='addNeuron()'>
                                +
                            </button>

                        </div>
                    </div>

                </div>

                <!-- Connection Section -->
                <div class='sidebar-section' v-if="settingsTab == 'connections'">

                    <h3 class='sidebar-header'>Connections</h3>

                    <div class='sidebar-section-content'>

                        <div v-for='(connection, index) in connections' class='config-item-container'>

                            <div class='config-item-header-container' onclick="toggleHideNext(this);">
                                <h5 class='config-item-header'>
                                Connection [[index + 1]]
                                </h5>
                                
                                <div class='config-item-header-delete-container' @click="removeConnection(index)">
                                    <i class="fas fa-times-circle close-icon" ></i>
                                </div>

                                <div class='config-item-header-options-container'>
                                    <i class="fas fa-ellipsis-v"></i>
                                </div>
                            </div>

                            <div class='config-item-body-container collapse'>

                                <div class="form-group sidebar-input-group row">
                                    <div class='col-4'>
                                        <label class='row sidebar-input-label' for="connection-source">Source</label>
                                        <small id="connection-source-help" class="form-text text-muted sidebar-input-help row">Source neuron</small>
                                    </div>
                                    <div class='col-8'>
                                        <select class="form-control" id="connection-source" v-model="connection.source" @change='drawConnections'>
                                            <option v-for='neuron in neurons' v-bind:value='neuron.gid'>
                                                Neuron [[neuron.gid]]
                                            </option>
                                        </select>
                                    </div>
                                    
                                </div>

                                <!-- `Section -->
                                <div class="form-group sidebar-input-group row">
                                    <div class='col-4'>
                                        <label class='row sidebar-input-label' for="connection-target">Target</label>
                                        <small id="connection-target-help" class="form-text text-muted sidebar-input-help row">Target neuron</small>
                                    </div>
                                    <div class='col-8'>
                                        <select class="form-control" id="connection-target" v-model="connection.target" @change='drawConnections'>
                                            <option v-for='neuron in neurons' v-bind:value='neuron.gid'>
                                                Neuron [[neuron.gid]]
                                            </option>
                                        </select>
                                    </div>
                                        
                                </div>

                                <!-- Location -->
                                <div class="form-group row sidebar-input-group">
                                    <div class='col-6'>
                                        <label class='row sidebar-input-label' for="con-sec">Section</label>
                                        <small id="con-sec-help" class="form-text text-muted sidebar-input-help row">Section to synapse on</small>
                                    </div>
                                    <div class='col-6'>
                                        <select class="form-control" id="con-sec" v-model="connection.section">
                                            <option v-for='sec in getSections(connection.target)' v-bind:value='sec.gid'>
                                                [[sec.name]]
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group row sidebar-input-group">
                                    <div class='col-8'>
                                        <label for="con-loc" class='row sidebar-input-label'>Location</label>
                                        <small id="con-locHelp" class="form-text text-muted sidebar-input-help row">Location of synapse on section</small>
                                    </div>
                                    <div class='col-4'>
                                        <input type="number" class="form-control sidebar-input-number" id="con-loc" v-model="connection.loc" min="0" max="1" step="0.1">
                                    </div>
                                </div>

                                <div class="form-group row sidebar-input-group" v-for='opt in labels.connections'>
                                    <div class='col-7'>
                                        <label v-bind:for="opt.attribute" class='row sidebar-input-label'>[[opt.label]]</label>
                                        <small v-bind:id="opt.attribute + 'Help'" class="form-text text-muted sidebar-input-help row">[[opt.helptext]]</small>
                                    </div>
                                    <div class='col-5'>
                                        <input type="number" class="form-control sidebar-input-number" v-bind:id="opt.attribute" v-model="connection[opt.attribute]">
                                    </div>
                                </div>
                            </div>

                        </div>
                        

                        <div class='new-config-item-container'>

                            <button class='new-config-item btn' @click='addConnection'>
                                +
                            </button>

                        </div>

                    </div>

                </div>


            </div>
            <!-- End Sidebar -->

            <!-- Content -->
            <div id='content-container'>

                <!-- Canvas -->
                <div id='canvas-container'>

                    <svg width=100% height=100% id='svg-canvas' onmousemove="updateCoords(event)">

                        <defs>

                            <radialGradient id="soma-gradient">
                              <stop offset="5%" stop-color="#cccccc00"></stop>
                              <stop offset="55%" stop-color="#cccccc55"></stop>
                              <stop offset="85%" stop-color="#cccccccc"></stop>
                              <stop offset="100%" stop-color="#cccccc"></stop>
                            </radialGradient>

                            <filter id="shadow2">
                                  <feDropShadow dx="0" dy="0" stdDeviation="3" 
                                      flood-color="#0000ff55"/>
                                </filter>

                        </defs>

                        <g id='svg-canvas-inner'>

                            <line x1="-5000" x2="5000" y1="0" y2="0" stroke='#cccccccc' stroke-width="1"></line>

                            <line y1="-5000" y2="5000" x1="0" x2="0" stroke='#cccccccc' stroke-width="1"></line>

                            <svg v-for='neuron in neurons' v-bind:x='neuron.x' v-bind:y='neuron.y' v-html='svgData.innerHTML' width="150px" height="150px" v-bind:id="'neuron-' + neuron.gid" class='neuron-container' viewBox="0 0 26.458332 26.458334">

                            </svg>

                            <svg v-for='neuron in neurons' v-bind:x='neuron.x' v-bind:y='neuron.y'>
                                <g>
                                    <rect  x="80px" y="0px" :width="neuronTextWidth(neuron.gid)" height="20px" rx="10px" ry="10px" :style="{fill : neuron.color}" class="neuron-pill" @click="selectNeuron(neuron.gid)"/>
                                    <text x="90px" y="14px" class='neuron-pill-text' :id="'neuron-text-' + neuron.gid" >[[neuron.name]]</text>
                                </g>
                            </svg>



                            <!-- <circle cx="100px" cy="100px" r="5px" id='point'></circle> -->

                            <!-- <svg class='neuron-container' x="100px" y="100px">

                                <circle class='soma' cx="100px" cy="100px" r="25px"/>

                                  <path class='axon'
                                  d="M 95 125 
                                     q -30 20, 1 40 
                                     t 1 40
                                     h5
                                     q 30 -20, 1 -40
                                     t 1 -40
                                     z" fill='#ccc'/>

                                    <path class='dendrite'
                                  d="M 105 75 
                                     q 15 -10, -1 -20 
                                     t -1 -20
                                     h-1
                                     q -15 10, -1 20
                                     t -1 20
                                     z" fill='#ccc'/>
                            </svg>
 -->
                        </g>

                    </svg>

                    <div id='canvas-coord-container'>
                        <span id='canvas-coords'></span>
                    </div>

                </div>

                <!-- Monitor -->

                <div id='monitor-container'>

                    <div id='monitor-nav'>

                        <div id='monitor-nav-title-container'>
                            <h2 id='monitor-title'>Monitor</h2>
                        </div>

                        <div class='monitor-tabs-container'>
                            <div v-for='view in views' class='monitor-tab-container'>
                                <div class='monitor-tab' v-bind:class="{ active: monitorTab == view}" @click="changeMonitorTab(view)">
                                    <h4 class='monitor-tab-title' v-html="(chartKey[view] || {}).label"></h4>
                                </div>
                            </div>

                        </div>

                        <div id="monitor-nav-settings-container" @click="monitorPopup">
                            <i class="fas fa-cog"></i>
                        </div>

                    </div>

                    <div v-if="monitorTab == 'spikes'" id='spike-container'>

                        <div id="spike-upper" class="row">

                            <div class='col' id='spike-y-axis'>

                                <div v-for="(secs, neuron, idx) in recording.views.spikes" class='row spike-row'>
                                    <h5 class='spike-row-title'>
                                        [[neuron]]
                                    </h5>
                                </div>

                            </div>

                            <div class='col' id='spike-main-container'>

                                <div v-for="(secs, neuron, idx) in recording.views.spikes" class='row spike-row'>
                                        <div class='spike-row-data' v-for="spike in secs.Soma" :style="{left: getTimeProp(spike), color: colors[idx]}"><span>|</span>
                                            <div class='spike-tooltip'>
                                                [[Math.round(spike)]]ms
                                            </div>
                                        </div>
                                </div>

                            </div>
                        </div>

                        <div id='spike-x-axis' class="row">
                            <div id='spike-x-axis-left'></div>
                            <div id='spike-x-axis-ticks-container'>
                                <div id='spike-x-axis-ticks'>
                                    <div class='spike-x-axis-tick' v-for='tick in xticks'>
                                        [[tick]]
                                    </div>

                                </div>
                                <div id='spike-x-axis-label'>
                                    Time (ms)
                                </div>
                            </div>
                        </div>

                    </div>

                    <canvas v-else id="monitor-canvas" width="100%" height="300px"></canvas>

                </div>

            </div>

        </div>
        <!-- End Main Container -->

    </div>
    <!-- End Outer Container -->

    <div id='popup-container' class='hide'>

        <!-- Save Popup -->
        <div id='save-popup-container' class='popup-container' v-show='popups.save'>
            
            <div id='save-popup' class='popup'>

                <!-- Header -->
                <div id='save-popup-header-container' class='popup-header-container'>
                    <h5 id='save-popup-header' class='popup-header'>Save Simulation
                    </h5>
                </div>

                <!-- Body -->
                <div id='save-popup-body-container' class='popup-body-container'>

                    <div id='save-popup-body' class='popup-body'>

                        <div class='form-row row popup-input-container'>

                            <div class='col-4'>

                                <label for='save-popup-filename'>Save as</label>
                            </div>

                            <div class='col-8'>

                                <input type='text' id='save-popup-filename' class='popup-form-input form-control' v-model='save.filename'>

                            </div>

                        </div>
                        
                        <div class='popup-button-container'>

                            <button type='button' class='btn popup-button cancel' @click='savePopup(false)'>Cancel</button>

                            <button type='button' class='btn popup-button save' @click='saveSimulation'>Save</button>
                            

                        </div>

                    </div>


                </div>

            </div>
        </div>
        <!-- End Save Popup -->

        <!-- Load Popup -->
        <div id='load-popup-container' class='popup-container' v-show='popups.load'>
            
            <div id='load-popup' class='popup'>

                <!-- Header -->
                <div id='load-popup-header-container' class='popup-header-container'>
                    <h5 id='load-popup-header' class='popup-header'>Load Simulation
                    </h5>
                </div>

                <!-- Body -->
                <div id='load-popup-body-container' class='popup-body-container'>

                    <div id='load-popup-body' class='popup-body'>

                        <div id='load-popup-selector'>

                            <div v-for='file in savedFiles'>

                                <div class='saved-file' :class="{ selected: load.selected == file.name}" @click='load.selected = file.name'>

                                    <h6 class='saved-file-name'>
                                        [[file.name]]
                                    </h6>

                                </div>

                            </div>

                        </div>
                        
                        <div class='popup-button-container'>

                            <button type='button' class='btn popup-button cancel' @click='loadPopup(false)'>Cancel</button>

                            <button type='button' class='btn popup-button save' @click='loadSimulation'>Load</button>
                            

                        </div>

                    </div>


                </div>

            </div>
        </div>
        <!-- End Load Popup -->

        <!-- Viz Popup -->
        <div id='viz-popup-container' class='popup-container' v-if="popups.monitor">
            
            <div id='viz-popup' class='popup'>

                <!-- Header -->
                <div id='viz-popup-header-container' class='popup-header-container'>
                    <h5 id='viz-popup-header' class='popup-header'>Monitor Settings
                    </h5>

                    <div class='popup-close-container' @click="closePopups">
                        <i class="fas fa-times"></i>
                    </div>
                </div>

                <!-- Body -->
                <div id='viz-popup-body-container' class='popup-body-container'>

                    <div id='viz-popup-body' class='popup-body'>

                        <div id='visible-select-container'>

                            <div class='viz-title'>
                                Neurons
                            </div>

                            <div id='viz-settings-neurons-container'>

                                <div class='viz-settings-neuron-container' v-for='neuron in neurons'>
                                    <div class='viz-settings-neuron' onclick="toggleHideNext(this);">
                                        <div class='viz-settings-neuron-title'>
                                            [[neuron.name]]
                                        </div>
                                        <div class='viz-settings-neuron-expand'>
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                    </div>

                                    <div class='viz-settings-sections-container'>
                                        <div class='viz-settings-section'
                                              v-for='section in neuron.sections'>
                                            <label class='viz-label' 
                                                   :for="neuron.name + '_' + section.name">[[section.name]]</label>
                                            <input type="checkbox" 
                                                    :id="neuron.name + '_' + section.name" 
                                                    :value="neuron.name + '_' + section.name" 
                                                    v-model="monitor.visible">
                                        </div>
                                    </div>
                                </div>

                            </div>
                            

                        </div>

                        <div id='viz-settings-container'>

                            <div class='viz-title'>
                                Settings
                            </div>

                            <div class='viz-settings-group' v-for="(axis, lab) in monitor.axes">

                                <div class='viz-settings-group-title'>
                                    [[axis.title]]
                                </div>

                                <div class='viz-settings-row'>

                                    <label class='viz-label'>Lock axis</label>

                                    <input type='checkbox' v-model="axis.lock">

                                </div>

                                <div class='viz-settings-row'>

                                    <label class='viz-label'>Minimum</label>

                                    <input type='number' class='axis-input' v-model.number="axis.min" :disabled="!axis.lock">

                                </div>

                                <div class='viz-settings-row'>

                                    <label class='viz-label'>Maximum</label>

                                    <input type='number' class='axis-input'  v-model.number="axis.max" :disabled="!axis.lock">

                                </div>


                            </div>

                            <button type='button' id="viz-confirm" class='btn popup-button save' @click='monitorApplySettings'>Confirm</button>


                        </div>
                        

                    </div>


                </div>

            </div>
        </div>
        <!-- End Viz Popup -->

        <!-- Neuron editor Popup -->
        <div id='editor-popup-container' class='popup-container' v-show='popups.editor'>
            
            <div id='editor-popup' class='popup'>

                <!-- Header -->
                <div id='editor-popup-header-container' class='popup-header-container'>
                    <h5 id='editor-popup-header' class='popup-header'>Neuron Editor
                    </h5>

                    <div class='popup-close-container' @click="closePopups">
                        <i class="fas fa-times"></i>
                    </div>
                </div>

                <!-- Content -->

                <div id='editor-popup-content-container'>

                    <!-- Sidebar -->
                    <div id='editor-popup-sidebar-container' class='popup-body-container editor-section'>

                        <div id='editor-popup-sidebar' class='popup-body'>

                            <div class='editor-sidebar-panel' id='editor-sidebar-panel-1' :class="{ active : editor.primary == '' }">

                                <!-- Section -->
                                <div class='editor-sidebar-section-outer' v-for='section in getSections(editor.neuron)'>

                                    <div class='editor-sidebar-item-container'  @click='editorSelect(section, $event)' :class="{active: editor.selection.includes(section)}">

                                        <div class='editor-sidebar-item'>
                                            [[section.name]]

                                        </div>

                                        <div class='editor-sidebar-item-icon-container' :data-target="'editor-segment-outer-' + section.gid" onclick="ToggleShowHide(this, event)">
                                            <i class="fas fa-chevron-down"></i>
                                        </div>

                                    </div>

                                    <!-- Segment -->
                                    <div class='editor-sidebar-segment-outer' :id="'editor-segment-outer-' + section.gid">
                                        <div class='editor-sidebar-item-container' v-for='(segment, segIdx) in section.segments' @click='editorSelect(segment, $event)' :class="{active: editor.selection.includes(segment) || editor.selection.includes(section)}">

                                            <div class='editor-sidebar-item'>
                                                Segment [[segIdx + 1]]
                                            </div>

                                        </div>

                                    </div>

                                </div>

                                <!-- Add section -->
                                <div class='editor-sidebar-section-outer' id='add-section-outer'>

                                    <div class='editor-sidebar-item-container' 
                                         id='add-section-container'
                                         data-target="editor-new-section"
                                         onclick="ToggleShowHide(this, event)">

                                        <div class='editor-sidebar-item'>
                                            Add Section

                                        </div>

                                        <div class='editor-sidebar-item-icon-container' 
                                             data-target="editor-new-section">
                                            <i class="fas fa-plus"></i>
                                        </div>

                                    </div>

                                    <div class='editor-sidebar-segment-outer' id="editor-new-section">
                                        <div class='form-row editor-param-section-body-container'>
                                            
                                            <div class="form-group col-12 editor-input-group">
                                                <div class='editor-input-row'>

                                                    <label for="editor-add-section-parent" class='editor-input-label'> Parent</label>
                                                    <select class="editor-input" id="editor-add-section-parent" 
                                                            v-model="editor.newSection.parent"
                                                            @change="editorUpdateSection">
                                                        <option :value="null">
                                                         None
                                                        </option>
                                                        <option v-for='osec in getSections(editor.neuron)' 
                                                                v-bind:value='osec.gid'>
                                                            [[osec.name]]
                                                        </option>
                                                    </select>

                                                </div>
                                            </div>

                                            <div class="form-group col-12 editor-input-group">
                                                <div class='editor-input-row'>
                                                        <label for="editor-add-section-name" 
                                                               class='editor-input-label'>
                                                           Name
                                                       </label>
                                                        <input type="text" class=" editor-input text" 
                                                        id="editor-add-section-name" v-model="editor.newSection.name">
                                                </div>
                                            </div>

                                            <div class="form-group col-12 editor-input-group">
                                                <div class='editor-input-row'>

                                                    <button class='addChannel btn' id='editor-add-section-button'
                                                            @click='addSection(editor.neuron, editor.newSection.name, editor.newSection.parent); editorClearNewSection()'>
                                                        Add
                                                    </button>

                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                </div>

                            </div>

                        </div>
                    </div>

                    <!-- Parameters -->
                    <div id='editor-popup-params-container' class='popup-body-container editor-section'>

                        <div id='editor-popup-params' class='popup-body'>

                            <!-- General -->

                            <div class='editor-param-section' v-if="'general' in editorParams">

                                <!-- Header -->
                                <div class='editor-param-section-header-container'>
                                    <h5 class='editor-param-section-header'>
                                        General
                                    </h5>
                                </div>
                                
                                <div class='form-row editor-param-section-body-container'>
                                    <div class="form-group col-12 editor-input-group" v-if="'name' in editorParams.general">
                                        <div class='editor-input-row'>
                                                <label for="name" class='editor-input-label'>Name</label>
                                                <input type="text" class=" editor-input text" 
                                                id="name" v-model="editorSection.name">
                                                <div class='info-container'>
                                                    <i class="fas fa-info"></i>
                                                </div>
                                                <div class='info-popup-container'>
                                                    <div class='info-popup'>
                                                        <b>Name:</b> 
                                                        <span>Name of the Neuron</span>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>

                                    <div class="form-group col-12 editor-input-group" v-if="'parent' in editorParams.general">
                                        <div class='editor-input-row'>
                                                <label for="parent" class='editor-input-label'> Parent</label>
                                                <select class="editor-input" id="section-parent" v-model="editorSection.parent">
                                                    <option :value="null">
                                                     None
                                                    </option>
                                                    <option v-for='osec in getSections(editor.neuron)' v-bind:value='osec.gid' v-if='osec.gid != editorSection.gid'>
                                                     [[osec.name]]
                                                    </option>
                                                </select>

                                                <div class='info-container'>
                                                    <i class="fas fa-info"></i>
                                                </div>
                                                <div class='info-popup-container'>
                                                    <div class='info-popup'>
                                                        <b>Parent Section:</b> <span>Section which this section will be attached to</span>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Geometry -->

                            <div class='editor-param-section' v-if="'geometry' in editorParams">

                                <!-- Header -->
                                <div class='editor-param-section-header-container'>
                                    <h5 class='editor-param-section-header'>
                                        Geometry
                                    </h5>
                                </div>
                                
                                <div class='form-row editor-param-section-body-container'>
                                    <div class="form-group col-md-6 editor-input-group" v-for='opt in labels.geometry' v-if='opt.attribute in editorParams.geometry'>
                                        <div class='editor-input-row'>
                                                <label v-bind:for="opt.attribute" class='editor-input-label'>[[opt.label]]</label>
                                                <input type="number" class=" editor-input number" 
                                                       v-bind:step="opt.step" v-bind:id="opt.attribute" 
                                                       v-model="editorParams.geometry[opt.attribute]" 
                                                       v-on:change="editorChange('geometry', opt.attribute, $event)">
                                                <div class='info-container'>
                                                    <i class="fas fa-info"></i>
                                                </div>
                                                <div class='info-popup-container'>
                                                    <div class='info-popup'>
                                                        <b>[[opt.label]]:</b> 
                                                        <span v-html="opt.helptext">
                                                        </span>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>

                                    <div class="form-group col-md-6 editor-input-group" v-if="'nseg' in editorParams.geometry">
                                        <div class='editor-input-row'>
                                                <label for="nseg" class='editor-input-label'> Segments</label>
                                                <input type="number" class=" editor-input number" step="1" id="nseg" 
                                                       v-model="editorParams.geometry.nseg" 
                                                       @change="updateEditorSegments($event)">

                                                <div class='info-container'>
                                                    <i class="fas fa-info"></i>
                                                </div>
                                                <div class='info-popup-container'>
                                                    <div class='info-popup'>
                                                        <b>No. Segments:</b> <span>Number of segments in section</span>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- Biophysics -->

                            <div class='editor-param-section' v-if="'biophysics' in editorParams">

                                <!-- Header -->
                                <div class='editor-param-section-header-container'>
                                    <h5 class='editor-param-section-header'>
                                        Biophysics
                                    </h5>
                                </div>
                                
                                <div class='form-row editor-param-section-body-container'>
                                    <div class="form-group col-md-6 editor-input-group" v-for='opt in labels.biophysics' v-if='opt.attribute in editorParams.biophysics'>
                                        <div class='editor-input-row'>
                                                <label v-bind:for="opt.attribute" class='editor-input-label'>[[opt.label]]</label>
                                                <input type="number" class=" editor-input number" v-bind:step="opt.step" v-bind:id="opt.attribute" v-model="editorParams.biophysics[opt.attribute]" v-on:change="editorChange('biophysics', opt.attribute, $event)">
                                                <div class='info-container'>
                                                    <i class="fas fa-info"></i>
                                                </div>
                                                <div class='info-popup-container'>
                                                    <div class='info-popup'>
                                                        <b>[[opt.label]]:</b> 
                                                        <span v-html="opt.helptext">
                                                        </span>
                                                    </div>
                                                </div>
                                        </div>
                                    </div>

                                </div>

                            </div>

                            <!-- Channels -->

                            <div class='editor-param-section' v-if="'channels' in editorParams">

                                <!-- Header -->
                                <div class='editor-param-section-header-container'>
                                    <h5 class='editor-param-section-header'>
                                        Channels
                                    </h5>
                                </div>

                                <div class='sidebar-input-group-container'
                                     v-for='(channel, channelName) in editorParams.channels'>

                                    <div class='editor-param-subheading-container'>

                                        <h5 class='editor-section-subheading'>[[channel.data('title')]]</h5>

                                        <div class='sidebar-section-subheading-icon-container' 
                                             v-if="editorSectionFlag"
                                             @click="editorRemoveChannel(channelName)">
                                            <i class="fas fa-times-circle close-icon" ></i>
                                        </div>

                                    </div>

                                    <div class='form-row editor-param-section-body-container'>
                                        <div class="form-group col-md-6 editor-input-group" 
                                             v-for='(val, param) in channel' v-if="param != 'data'">
                                            <div class='editor-input-row'>
                                                    <label v-bind:for="param" class='editor-input-label'>
                                                        [[channel.data('title', param)]]
                                                    </label>
                                                    <input type="number" class="editor-input number" 
                                                           v-bind:step="channel.data('step', param)" 
                                                           v-bind:id="param" v-model="channel[param]" 
                                                           v-on:change="editorChange('channels.'+channelName, param, $event)">
                                                    <div class='info-container'>
                                                        <i class="fas fa-info"></i>
                                                    </div>
                                                    <div class='info-popup-container'>
                                                        <div class='info-popup'>
                                                            <b>[[channel.data('title', param)]]:</b> 
                                                            <span v-html="channel.data('help', param)">
                                                            </span>
                                                        </div>
                                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add channel -->
                                <div class='form-row editor-param-section-body-container'>
                                    <div class="form-group col-12 editor-input-group">
                                        <div id="add-channel-row" class='editor-input-row'>

                                            <div id='add-channel-left'>

                                                <h5 class='editor-section-subheading' id='add-channel-header'>
                                                    Add a Channel
                                                </h5>

                                                <select id="editor-add-channel-select" class="editor-input" 
                                                        v-model="editor.selectedChannel">
                                                    <option v-for="channel in editorAvailableChannels" 
                                                            v-bind:value='channel.name'>
                                                        [[channel.title]]
                                                    </option>
                                                </select>
                                            </div>
                                            <button id="editor-add-channel-btn" class='new-config-item btn' 
                                                    @click="editorAddChannel()">+
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Body -->
                    <div id='editor-popup-body-container' class='popup-body-container editor-section'>

                        <div id='editor-popup-body' class='popup-body'>

                            <svg id='editor-neuron-display' v-html='svgData.innerHTML' width="300px" height="300px"   viewBox="0 0 26.458332 26.458334">

                        </div>


                    </div>
                    <!-- End body -->

                </div>
                <!-- End content -->

            </div>
        </div>
        <!-- End Editor Popup -->

    </div>

    <!-- Toast Container -->
    <div id='toast-container'>
        <!-- Then put toasts within -->
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" v-for='toast in toasts' :id="'toast-'+toast.gid">
              <div class="toast-header">
                <!-- <img src="..." class="rounded mr-2" alt="..."> -->
                <strong class="mr-auto" :class="'text-'+toast.level">[[toast.title]]</strong>
                <small class="text-muted toast-subtitle">[[toast.subtitle]]</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="toast-body">

                <div class='toast-section' v-for='(val, key, index) in toast.messages'>
                    <h5 class='toast-section-header'>[[key]]</h5>
                    <ul>
                        <li v-for='msg in val'>[[msg]]</li>
                    </ul>
              </div>

              [[toast.message]]
            </div>
        </div>

    </div>
  
</div>  

<template id="neuron-template">
</template>

<script src="{% static 'spyke/data.js' %}"> </script>

<script src="{% static 'spyke/aux.js' %}"> </script>

<script src="{% static 'spyke/interface.js' %}"> </script>

{% endblock %}